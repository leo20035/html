<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北北基桃1200月票週期計算機</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }

        #calendar-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* 自動調整每行月曆數量 */
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .month-calendar {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .month-header {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            gap: 1px;
        }

        .day-name {
            font-weight: bold;
            padding: 5px 0;
            background-color: #eef;
            color: #666;
            font-size: 0.85em;
        }

        .date-cell {
            padding: 8px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .date-cell:hover {
            background-color: #e0f7fa;
        }

        .disabled-day {
            color: #ccc;
            cursor: default;
        }
        
        /* 不同的月票週期標記顏色 */
        .period-1 { background-color: #ffcccc !important; color: #a00; } /* 週期 1: 淡紅 */
        .period-2 { background-color: #ccffcc !important; color: #0a0; } /* 週期 2: 淡綠 */
        .period-3 { background-color: #ccccff !important; color: #00a; } /* 週期 3: 淡藍 */
        .period-4 { background-color: #ffccff !important; color: #a0a; } /* 週期 4: 淡紫 */
        /* 您可以繼續添加更多週期顏色 */

        .start-date {
            border: 2px solid #333;
            box-shadow: 0 0 5px #333;
        }

        #info-panel {
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #007bff;
            background-color: #eaf5ff;
            border-radius: 8px;
            max-width: 600px;
            text-align: center;
        }
        
        #info-panel p {
            margin: 5px 0;
            font-size: 1.1em;
            color: #007bff;
        }
    </style>
</head>
<body>

    <h1 style="text-align: center; color: #007bff;">基北北桃1200月票週期計算機</h1>
    <p style="text-align: center; color: #666;">點擊日曆上的日期，即可計算並標示後續 16 個月票週期（每 30 天）</p>

    <div id="calendar-container">
    </div>
    
    <div id="info-panel">
        <p id="selected-date-info">請點擊一個日期作為您的月票啟用日。</p>
        <p id="period-info"></p>
    </div>

    <script>
        // 設定每張月票的有效天數
        const PERIOD_DAYS = 30;
        // 日曆顯示的月數
        const MONTHS_TO_DISPLAY = 16; 
        
        // 週的名稱
        const dayNames = ['日', '一', '二', '三', '四', '五', '六'];
        
        // 顏色類別的陣列，用於標記不同週期
        const periodClasses = ['period-1', 'period-2', 'period-3', 'period-4'];

        /**
         * 取得某個月份的第一天是星期幾 (0=日, 6=六)
         * @param {Date} date - 該月內的任一天
         * @returns {number} 星期幾
         */
        function getFirstDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
        }

        /**
         * 取得某個月份的總天數
         * @param {number} year - 年份
         * @param {number} month - 月份 (0-11)
         * @returns {number} 總天數
         */
        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }
        
        /**
         * 格式化日期為 YYYY-MM-DD
         * @param {Date} date - 日期物件
         * @returns {string} 格式化後的日期字串
         */
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        /**
         * 將日期字串 YYYY-MM-DD 轉為 Date 物件
         * @param {string} dateString - 日期字串
         * @returns {Date} Date 物件
         */
        function parseDate(dateString) {
            const parts = dateString.split('-');
            // 注意：月份在 Date 物件中是 0-11
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        /**
         * 生成一個月份的日曆 HTML
         * @param {Date} date - 該月內的任一天
         * @returns {string} 日曆的 HTML 結構
         */
        function generateMonthCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const monthName = `${year} 年 ${month + 1} 月`;
            const daysInMonth = getDaysInMonth(year, month);
            const firstDayIndex = getFirstDayOfMonth(date); // 該月第一天是星期幾

            let html = `
                <div class="month-calendar" data-year="${year}" data-month="${month + 1}">
                    <div class="month-header">${monthName}</div>
                    <div class="calendar-grid">
            `;

            // 1. 寫入星期名稱
            dayNames.forEach(day => {
                html += `<div class="day-name">${day}</div>`;
            });

            // 2. 寫入前導空白 (上個月的日期)
            for (let i = 0; i < firstDayIndex; i++) {
                html += `<div class="date-cell disabled-day"></div>`;
            }

            // 3. 寫入本月日期
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateString = formatDate(currentDate);
                
                html += `
                    <div class="date-cell" data-date="${dateString}">${day}</div>
                `;
            }
            
            // 4. 寫入結尾空白 (下個月的日期)
            const totalCells = firstDayIndex + daysInMonth;
            const remainingCells = (42 - totalCells) % 7; // 一個日曆最多 6 行 7 列 = 42
            for (let i = 0; i < remainingCells; i++) {
                html += `<div class="date-cell disabled-day"></div>`;
            }

            html += `
                    </div>
                </div>
            `;
            return html;
        }

        /**
         * 生成並顯示日曆
         */
        function renderCalendar() {
            const container = $('#calendar-container');
            container.empty();
            
            // 取得上個月的日期
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);

            for (let i = 0; i < MONTHS_TO_DISPLAY; i++) {
                const currentMonthDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + i, 1);
                const calendarHtml = generateMonthCalendar(currentMonthDate);
                container.append(calendarHtml);
            }
        }

        /**
         * 點擊日期後，計算並標示月票週期
         * @param {string} startDateString - 月票的啟用日期 (YYYY-MM-DD)
         */
        function calculateAndMarkPeriods(startDateString) {
            $('.date-cell').removeClass(periodClasses.join(' ')).removeClass('start-date'); // 清除所有標記
            
            let currentStartDate = parseDate(startDateString);
            
            // 標記起用日
            $(`div[data-date="${startDateString}"]`).addClass('start-date');

            // 顯示資訊
            $('#selected-date-info').text(`月票啟用日：${startDateString}`);
            let infoHtml = '<ul>';
            
            for (let i = 0; i < MONTHS_TO_DISPLAY; i++) { // 計算 14 個週期
                
                // 週期結束日 (啟用日 + 29 天, 因為啟用日是第 1 天)
                let endDate = new Date(currentStartDate);
                endDate.setDate(currentStartDate.getDate() + PERIOD_DAYS - 1); 
                
                const periodIndex = i % periodClasses.length; // 循環使用顏色
                const periodClass = periodClasses[periodIndex];

                infoHtml += `<li>**週期 ${i + 1}**：從 ${formatDate(currentStartDate)} 啟用，至 ${formatDate(endDate)} 截止。</li>`;
                
                // 標記該週期內的每一天
                let currentDate = new Date(currentStartDate);
                while (currentDate <= endDate) {
                    const dateString = formatDate(currentDate);
                    $(`div[data-date="${dateString}"]`).addClass(periodClass);
                    currentDate.setDate(currentDate.getDate() + 1); // 往前推一天
                }

                // 下一個週期從結束日的下一天開始
                currentStartDate = new Date(endDate);
                currentStartDate.setDate(currentStartDate.getDate() + 1);
            }
            infoHtml += '</ul>';
            $('#period-info').html(infoHtml);
        }

        $(document).ready(function() {
            renderCalendar();

            // 綁定日期點擊事件
            $('#calendar-container').on('click', '.date-cell:not(.disabled-day)', function() {
                const dateString = $(this).data('date');
                if (dateString) {
                    calculateAndMarkPeriods(dateString);
                }
            });
        });
    </script>

</body>
</html>
